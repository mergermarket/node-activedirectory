var t,e=require("url"),r=require("bunyan"),n=require("underscore"),i=require("async"),o=require("ldapjs"),s=require("util");function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var a=require("events"),f=s,l=o,c=i,p=n,d=r,g=e,h={},b=n,y=function(t){if(!(this instanceof y))return new y(t);for(var e in t||{})Array.prototype.hasOwnProperty.call(t,e)&&(this[e]=t[e])};y.prototype.isMemberOf=function(t){return!!t&&(t=(t||"").toLowerCase(),b.any(this.groups||[],(function(e){return((e||{}).cn||"").toLowerCase()===t})))},h=y;var m={},v=function(t){if(!(this instanceof v))return new v(t);for(var e in t||{})Array.prototype.hasOwnProperty.call(t,e)&&(this[e]=t[e])};m=v;var N={},j=n;var C=function(t){if(!(this instanceof C))return new C(t);if(!t)throw new Error("No attribute provided to create a range retrieval specifier.");for(var e in"string"==typeof t&&(t=function(t){var e=new RegExp("^([^;]+);range=(\\d+)-(.+)?$","i").exec(t);return{attributeName:e[1],low:parseInt(e[2]),high:parseInt(e[3])||null}}(t)),t)Array.prototype.hasOwnProperty.call(t,e)&&(this[e]=t[e])};C.prototype.next=function(){if(null!=this.high&&this.high!=this.low){var t=this.low,e=this.high;return this.low=e+1,this.high=e+(e-t)+1,this}return null},C.prototype.isComplete=function(){return null==this.high||void 0===this.high},C.prototype.toString=function(){return this.attributeName+";range="+this.low+"-"+(this.high?this.high:"*")},C.prototype.getRangeAttributes=function(t){var e=[];for(var r in t||{})if(C.prototype.isRangeAttribute(r)){var n=new C(r);e.push(n)}return e.length>0?e:null},C.prototype.isRangeAttribute=function(t){return new RegExp("^([^;]+);range=(\\d+)-(.+)?$","i").test(t)},C.prototype.hasRangeAttributes=function(t){return j.any(j.keys(t||{}),(function(t){return C.prototype.isRangeAttribute(t)}))},N=C;var D,w,A,S,E=d.createLogger({name:"ActiveDirectory",streams:[{level:"fatal",stream:process.stdout}]});D=w={user:["dn","userPrincipalName","sAMAccountName","mail","lockoutTime","whenCreated","pwdLastSet","userAccountControl","employeeID","sn","givenName","initials","cn","displayName","comment","description"],group:["dn","cn","description"]},A=S={enabled:!1,exclude:["ldaps?://ForestDnsZones\\..*/.*","ldaps?://DomainDnsZones\\..*/.*","ldaps?://.*/CN=Configuration,.*"]};var R={isDistinguishedName:/(([^=]+=.+),?)+/gi,isUserResult:/CN=Person,CN=Schema,CN=Configuration,.*/i,isGroupResult:/CN=Group,CN=Schema,CN=Configuration,.*/i},x=function(t,e,r,n,i){if(!(this instanceof x))return new x(t,e,r,n,i);this.opts={},"string"==typeof t?(this.opts.url=t,this.baseDN=e,this.opts.bindDN=r,this.opts.bindCredentials=n,"function"==typeof(i||{}).entryParser&&(this.opts.entryParser=i.entryParser)):(this.opts=p.defaults({},t),this.baseDN=this.opts.baseDN,this.opts.bindDN||(this.opts.bindDN=this.opts.username),this.opts.bindCredentials||(this.opts.bindCredentials=this.opts.password),this.opts.logging&&(E=d.createLogger(p.defaults({},this.opts.logging)),delete this.opts.logging)),D=p.extend({},w,(this.opts||{}).attributes||{},(i||{}).attributes||{}),A=p.extend({},S,(this.opts||{}).referrals||{},(i||{}).referrals||{}),E.info("Using username/password (%s/%s) to bind to ActiveDirectory (%s).",this.opts.bindDN,"********",this.opts.url),E.info("Referrals are %s",A.enabled?"enabled. Exclusions: "+JSON.stringify(A.exclude):"disabled"),E.info("Default user attributes: %j",D.user||[]),E.info("Default group attributes: %j",D.group||[]),void 0===this.opts.maxConnections&&(this.opts.maxConnections=20),a.EventEmitter.call(this)};function G(t,e){if(void 0===e&&(e=256),!t)return t;"string"!=typeof t&&(t=t.toString());var r=t.length;if(!r||r<e+3)return t;var n=Math.ceil((e-3)/2),i=Math.floor((e-3)/2);return t.slice(0,n)+"..."+t.slice(r-i)}function O(t){return a.EventEmitter.listenerCount(this,t)>0}function U(t){return E.trace("isDistinguishedName(%s)",t),!(!t||0===t.length)&&(R.isDistinguishedName.lastIndex=0,R.isDistinguishedName.test(t))}function q(t){return E.trace("parseDistinguishedName(%s)",t),t?(t=t.replace(/"/g,'\\"')).replace("\\,","\\\\,"):t}function P(t){E.trace("getUserQueryFilter(%s)",t);return t?U.call(this,t)?"(&(objectCategory=User)(distinguishedName="+q(t)+"))":"(&(objectCategory=User)(|(sAMAccountName="+t+")(userPrincipalName="+t+")))":"(objectCategory=User)"}function T(t){return E.trace("getCompoundFilter(%s)",t),!!t&&("("===t.charAt(0)&&")"===t.charAt(t.length-1)?t:"("+t+")")}function I(t){E.trace("getGroupQueryFilter(%s)",t);return t?U.call(this,t)?"(&(objectCategory=Group)(distinguishedName="+q(t)+"))":"(&(objectCategory=Group)(cn="+t+"))":"(objectCategory=Group)"}function L(t){return E.trace("isGroupResult(%j)",t),!!t&&(!!t.groupType||(t.objectCategory?(R.isGroupResult.lastIndex=0,R.isGroupResult.test(t.objectCategory)):!!(t.objectClass&&t.objectClass.length>0)&&p.any(t.objectClass,(function(t){return"group"===t.toLowerCase()}))))}function M(t){return E.trace("isUserResult(%j)",t),!!t&&(!!t.userPrincipalName||(t.objectCategory?(R.isUserResult.lastIndex=0,R.isUserResult.test(t.objectCategory)):!!(t.objectClass&&t.objectClass.length>0)&&p.any(t.objectClass,(function(t){return"user"===t.toLowerCase()}))))}function F(t,e){if(!(t=t||this.url||(this.opts||{}).url||(e||{}).url))throw"No url specified for ActiveDirectory client.";E.trace("createClient(%s)",t);e=_(p.defaults({},{url:t},e,this.opts));return E.debug("Creating ldapjs client for %s. Opts: %j",e.url,p.omit(e,"url","bindDN","bindCredentials")),l.createClient(e)}function k(t){return E.trace("isAllowedReferral(%j)",t),!!A.enabled&&(!!t&&!p.any(A.exclude,(function(e){return new RegExp(e,"i").test(t)})))}function Q(t){return p.defaults({},_(t),function(t){return p.pick(t||{},"filter","scope","attributes","controls","paged","sizeLimit","timeLimit","typesOnly","derefAliases")}(t))}function _(t){return p.pick(t||{},"url","host","port","secure","tlsOptions","socketPath","log","timeout","idleTimeout","reconnect","queue","queueSize","queueTimeout","queueDisable","bindDN","bindCredentials","maxConnections")}function z(t,e,r){var n=this;"function"==typeof e&&(r=e,e=t,t=void 0),"object"===u(t)&&(e=t,t=void 0),e||(e={}),t||(t=e.baseDN)||(t=n.baseDN),E.trace("search(%s,%j)",t,e);var i=!1,o=[],s=0,a=F.call(n,null,e);function f(t){if(t){t.unbind();var e=o.indexOf(t);e>=0&&o.splice(e,1)}}a.on("error",b);var c=(e||{}).entryParser||(n.opts||{}).entryParser||function(t,e,r){r(t)};function d(t){E.trace("onSearchEntry(%j)",t);var r=t.object;delete r.controls,s++,W.call(n,r,e,(function(e,r){s--,e&&(r=t.object),c(r,t.raw,(function(t){t&&m.push(t),!s&&i&&y()}))}))}function h(t){for(var r,i=0;r=(t.uris||[])[i++];)if(k(r)){E.debug("Following LDAP referral chase at %s",r);var s=F.call(n,r,e);o.push(s);var u=(g.parse(r).pathname||"/").substring(1);s.search(u,Q(e),v,(function(t,r){function n(t){E.error(t,"[%s] An error occurred chasing the LDAP referral on %s (%j)",(t||{}).errno,u,e),f(s)}t?n(t):(r.on("searchEntry",d),r.on("searchReference",h),r.on("error",n),r.on("end",(function(t){f(s),y()})))}))}}function b(n,i){"SizeLimitExceededError"!==(n||{}).name?(a.unbind(),E.error(n,"[%s] An error occurred performing the requested LDAP search on %s (%j)",(n||{}).errno||"UNKNOWN",t,e),r&&r(n)):y(i)}function y(n){!s&&o.length<=0&&(a.unbind(),E.info('Active directory search (%s) for "%s" returned %d entries.',t,G(e.filter),(m||[]).length),r&&r(null,m))}var m=[],v=e.controls||(e.controls=[]);p.any(v,(function(t){return t instanceof l.PagedResultsControl}))||(E.debug('Adding PagedResultControl to search (%s) with filter "%s" for %j',t,G(e.filter),p.any(e.attributes)?e.attributes:"[*]"),v.push(new l.PagedResultsControl({value:{size:1e3}}))),e.includeDeleted&&(p.any(v,(function(t){return"1.2.840.113556.1.4.417"===t.type}))||(E.debug('Adding ShowDeletedOidControl(1.2.840.113556.1.4.417) to search (%s) with filter "%s" for %j',t,G(e.filter),p.any(e.attributes)?e.attributes:"[*]"),v.push(new l.Control({type:"1.2.840.113556.1.4.417",criticality:!0})))),E.debug('Querying active directory (%s) with filter "%s" for %j',t,G(e.filter),p.any(e.attributes)?e.attributes:"[*]"),a.search(t,Q(e),v,(function(t,e){t?r&&r(t):(e.on("searchEntry",d),e.on("searchReference",h),e.on("error",(function(t){b(t,e)})),e.on("end",(function(t){i=!0,y()})))}))}function W(t,e,r){E.trace("parseRangeAttributes(%j,%j)",t,e);if(N.prototype.hasRangeAttributes(t)){var n=N.prototype.getRangeAttributes(t);if(!n||n.length<=0)r(null,t);else{var i=[];if(p.each(n,(function(e,r){t[e.attributeName]||(t[e.attributeName]=[]),Array.prototype.push.apply(t[e.attributeName],t[e.toString()]),delete t[e.toString()];var n=e.next();n&&!n.isComplete()&&i.push(n.toString())})),i.length<=0)return E.debug("All attribute ranges %j retrieved for %s",n,t.dn),void r(null,t);E.debug('Attribute range retrieval specifiers %j found for "%s". Next range: %j',n,t.dn,i),e=p.defaults({filter:"(distinguishedName="+q(t.dn)+")",attributes:i},e),z.call(this,e,(function(e,n){if(e)r(e);else{var i=(n||[])[0];for(var o in i)i.hasOwnProperty(o)&&(t[o]||(t[o]=[]),p.isArray(t[o])&&Array.prototype.push.apply(t[o],i[o]));r(null,t)}}))}}else r(null,t)}function H(t){return void 0!==t&&(0===t.length||p.any(t||[],(function(t){return"*"===t})))}function Z(t){return H((t||{}).attributes)?[]:p.union(["dn","objectCategory","groupType","cn"],tt(t,"group")?["member"]:[])}function $(t){return H((t||{}).attributes)?[]:p.union(["dn","cn"],tt(t,"user")?["member"]:[])}function B(){for(var t=0,e=arguments.length;t<e;t++)if(H(arguments[t]))return[];return p.union.apply(this,arguments)}function J(t,e){return H(e)&&(e=function(){return!0}),p.pick(t,e)}function K(t,e,r,n){var i=this;if("function"==typeof r&&(n=r,r=void 0),"function"==typeof e&&(n=e,e=t,t=void 0),"string"==typeof t&&(r=e,e=t,t=void 0),E.trace("getGroupMembershipForDN(%j,%s,stack:%j)",t,e,(r||[]).length),!e){var o=new Error("No distinguishedName (dn) specified for group membership retrieval.");return E.error(o),O("error")&&i.emit("error",o),n(o)}t=p.defaults(p.omit(t||{},"filter","scope","attributes"),{filter:"(member="+q(e)+")",scope:"sub",attributes:B((t||{}).attributes||D.group,["groupType"])}),z.call(i,t,(function(o,s){if(o)n(o);else{var u=[];c.forEach(s,(function(n,o){if(void 0!==r){if(p.findWhere(r,{cn:n.cn}))return o();r.push(new m(n)),p.each(r,(function(t){p.findWhere(u,{cn:t.cn})||u.push(t)}))}L(n)?(E.debug('Adding group "%s" to %s"',n.dn,e),u.push(new m(n)),E.debug('Retrieving nested group membership for group "%s"',n.dn),K.call(i,t,n.dn,u,(function(t,r){t?o(t):(r=p.map(r,(function(t){if(L(t))return new m(t)})),E.debug('Group "%s" which is a member of group "%s" has %d nested group(s). Nested: %j',n.dn,e,r.length,p.map(r,(function(t){return t.dn}))),Array.prototype.push.apply(u,r),o())}))):o()}),(function(t){t?n(t):(u=p.uniq(p.sortBy(u,(function(t){return t.cn||t.dn})),!1,(function(t){return t.dn})),E.info('Group "%s" has %d group(s). Groups: %j',e,u.length,p.map(u,(function(t){return t.dn}))),n(t,u))}))}}))}function V(t,e,r){"function"==typeof e&&(r=e,e=t,t=void 0),"string"==typeof t&&(e=t,t=void 0),E.trace("getDistinguishedNames(%j,%j)",t,e),t=p.defaults(p.omit(t||{},"attributes"),{filter:e,scope:"sub",attributes:B((t||{}).attributes||[],["dn"])}),z.call(this,t,(function(e,n){if(e)r&&r(e);else{var i=p.map(n,(function(t){return t.dn}));E.info('%d distinguishedName(s) found for LDAP query: "%s". Results: %j',n.length,G(t.filter),n),r(null,i)}}))}function X(t,e,r){if("function"==typeof e&&(r=e,e=t,t=void 0),E.trace("getDistinguishedName(%j,%s)",t,e),U.call(this,e))return E.debug('"%s" is already a distinguishedName. NOT performing query.',e),void r(null,e);V.call(this,t,P(e),(function(t,n){t?r(t):(E.info('%d distinguishedName(s) found for user: "%s". Returning first dn: "%s"',(n||[]).length,e,(n||[])[0]),r(null,(n||[])[0]))}))}function Y(t,e,r){if("function"==typeof e&&(r=e,e=t,t=void 0),E.trace("getGroupDistinguishedName(%j,%s)",t,e),U.call(this,e))return E.debug('"%s" is already a distinguishedName. NOT performing query.',e),void r(null,e);V.call(this,t,I(e),(function(t,n){t?r(t):(E.info('%d distinguishedName(s) found for group "%s". Returning first dn: "%s"',(n||[]).length,e,(n||[])[0]),r(null,(n||[])[0]))}))}function tt(t,e){"string"==typeof t&&(e=t,t=this.opts);var r=(e||"").toLowerCase();return p.any((t||this.opts||{}).includeMembership||[],(function(t){return"all"===(t=t.toLowerCase())||t===r}))}f.inherits(x,a.EventEmitter),x.filters=l.filters,x.prototype._getDefaultAttributes=function(){return p.defaults({},D)},x.prototype._getDefaultUserAttributes=function(){return p.defaults({},(D||{}).user)},x.prototype._getDefaultGroupAttributes=function(){return p.defaults({},(D||{}).group)},x.prototype.getUsersForGroup=function(t,e,r){var n=this;"function"==typeof e&&(r=e,e=t,t=void 0),E.trace("getUsersForGroup(%j,%s)",t,e);var i=[];n.findGroup(p.defaults({},p.omit(t||{},"attributes"),{attributes:B((t||{}).attributes||D.group,["member"])}),e,(function(o,s){if(o)r&&r(o);else if(s){"string"==typeof s.member&&(s.member=[s.member]);var u=function(t,e){for(var r=[],n=0,i=t.length;n<i;n+=e)r.push(t.slice(n,n+e));return r}(s.member||[],1e3);u.length>1&&E.debug('Splitting %d member(s) of "%s" into %d parallel chunks',(s.member||[]).length,e,u.length);var a=0;c.each(u,(function(e,r){var o=p.reduce(e||[],(function(t,e,r){return t+"(distinguishedName="+q(e)+")"}),""),s={filter:o="(&(|(objectCategory=User)(objectCategory=Group))(|"+o+"))",scope:"sub",attributes:B((t||{}).attributes||D.user||[],$(t),["groupType"])};z.call(n,s,(function(e,o){e?r(e):c.forEach(o,(function(e,r){if(e.groupType)n.getUsersForGroup(t,e.cn,(function(t,e){i.push.apply(i,e),r()}));else{var o=new h(J(e,(t||{}).attributes||D.user));n.emit(o),i.push(o),r()}}),(function(t){u.length>1&&E.debug("Finished processing chunk %d/%d",++a,u.length),r(t)}))}))}),(function(t){i=p.uniq(i,(function(t){return t.dn||t})),E.info('%d user(s) belong in the group "%s"',i.length,e),r&&r(null,i)}))}else r&&r(null,s)}))},x.prototype.getGroupMembershipForUser=function(t,e,r){var n=this;"function"==typeof e&&(r=e,e=t,t=void 0),E.trace("getGroupMembershipForUser(%j,%s)",t,e),X.call(n,t,e,(function(i,o){if(!i)return o?void K.call(n,t,o,(function(e,i){if(e)r&&r(e);else{var o=[];p.each(i,(function(e){var r=new m(J(e,(t||{}).attributes||D.group));n.emit(r),o.push(r)})),r&&r(e,o)}})):(E.warn('Could not find a distinguishedName for the specified username: "%s"',e),void(r&&r()));r&&r(i)}))},x.prototype.getGroupMembershipForGroup=function(t,e,r){var n=this;"function"==typeof e&&(r=e,e=t,t=void 0),E.trace("getGroupMembershipForGroup(%j,%s)",t,e),Y.call(n,t,e,(function(i,o){if(!i)return o?void K.call(n,t,o,(function(e,i){if(e)r&&r(e);else{var o=[];p.each(i,(function(e){var r=new m(J(e,(t||{}).attributes||D.group));n.emit(r),o.push(r)})),r&&r(e,o)}})):(E.warn('Could not find a distinguishedName for the specified group name: "%s"',e),void(r&&r()));r&&r(i)}))},x.prototype.userExists=function(t,e,r){"function"==typeof e&&(r=e,e=t,t=void 0),E.trace("userExists(%j,%s)",t,e),this.findUser(t,e,(function(t,n){t?r(t):(E.info('"%s" %s exist.',e,null!=n?"DOES":"DOES NOT"),r(null,null!=n))}))},x.prototype.groupExists=function(t,e,r){"function"==typeof e&&(r=e,e=t,t=void 0),E.trace("groupExists(%j,%s)",t,e),this.findGroup(t,e,(function(t,n){t?r(t):(E.info('"%s" %s exist.',e,null!=n?"DOES":"DOES NOT"),r(null,null!=n))}))},x.prototype.isUserMemberOf=function(t,e,r,n){"function"==typeof r&&(n=r,r=e,e=t,t=void 0),E.trace("isUserMemberOf(%j,%s,%s)",t,e,r),t=p.defaults(p.omit(t||{},"attributes"),{attributes:["cn","dn"]}),this.getGroupMembershipForUser(t,e,(function(t,i){if(t)n(t);else{if(!i||0===i.length)return E.info('"%s" IS NOT a member of "%s". No groups found for user.',e,r),void n(null,!1);var o=(r||"").toLowerCase(),s=p.any(i,(function(t){return(t.dn||"").toLowerCase()===o||(t.cn||"").toLowerCase()===o}));E.info('"%s" %s a member of "%s"',e,s?"IS":"IS NOT",r),n(null,s)}}))},x.prototype.find=function(t,e){var r=this;"function"==typeof t&&(e=t,t=void 0),"string"==typeof t&&(t={filter:t}),E.trace("find(%j)",t);var n=p.defaults(p.omit(t||{},"attributes"),{scope:"sub",attributes:B((t||{}).attributes||[],D.group||[],D.user||[],Z(t),$(t),["objectCategory"])});z.call(r,n,(function(i,o){if(i)e&&e(i);else{if(!o||0===o.length)return E.warn('No results found for query "%s"',G(n.filter)),e&&e(),void r.emit("done");var s={users:[],groups:[],other:[]};c.forEach(o,(function(e,n){if(L(e)){var i=new m(J(e,(t||{}).attributes||D.group));s.groups.push(i),tt(t,"group")?K.call(r,t,i.dn,(function(t,e){if(t)return n(t);i.groups=e,r.emit("group",i),n()})):(r.emit("group",i),n())}else if(M(e)){var o=new h(J(e,(t||{}).attributes||D.user));s.users.push(o),tt(t,"user")?K.call(r,t,o.dn,(function(t,e){if(t)return n(t);o.groups=e,r.emit("user",o),n()})):(r.emit("user",o),n())}else{var u=J(e,(t||{}).attributes||p.union(D.user,D.group));s.other.push(u),r.emit("other",u),n()}}),(function(n){n?e&&e(n):(E.info('%d group(s), %d user(s), %d other found for query "%s". Results: %j',s.groups.length,s.users.length,s.other.length,G(t.filter),s),r.emit("groups",s.groups),r.emit("users",s.users),e&&e(null,s))}))}}))},x.prototype.findDeletedObjects=function(t,e){var r=this;"function"==typeof t&&(e=t,t=void 0),"string"==typeof t&&(t={filter:t}),E.trace("findDeletedObjects(%j)",t);function n(t,n){z.call(r,t,p.defaults({},n,{includeDeleted:!0}),(function(t,o){if(t)e&&e(t);else{if(!o||0===o.length)return E.warn('No deleted objects found for query "%s"',G(n.filter)),e&&e(),void r.emit("done");var s=[];p.forEach(deletedItemss,(function(t){var e=J(t,(n|{}).attributes||[]);r.emit("entry:deleted",e),s.push(e)})),E.info('%d deleted objects found for query "%s". Results: %j',s.length,G(i.filter),s),r.emit("deleted",s),e&&e(null,s)}}))}var i=p.defaults(t||{},{scope:"one",attributes:B((t||{}).attributes||[],["attributeID","attributeSyntax","dnReferenceUpdate","dNSHostName","flatName","governsID","groupType","instanceType","lDAPDisplayName","legacyExchangeDN","mS-DS-CreatorSID","mSMQOwnerID","nCName","objectClass","objectGUID","objectSid","oMSyntax","proxiedObjectName","replPropertyMetaData","sAMAccountName","securityIdentifier","sIDHistory","subClassOf","systemFlags","trustPartner","trustDirection","trustType","trustAttributes","userAccountControl","uSNChanged","uSNCreated","whenCreated","msDS-AdditionalSam­AccountName","msDS-Auxiliary-Classes","msDS-Entry-Time-To-Die","msDS-IntId","msSFU30NisDomain","nTSecurityDescriptor","uid"]),controls:[]});i.baseDN?n(i.baseDN,i):(E.debug("No baseDN specified for Deleted Object. Querying RootDSE at %s.",r.opts.url),x.prototype.getRootDSE(r.opts.url,["defaultNamingContext"],(function(t,o){t?e&&e(t):(E.info("Retrieved defaultNamingContext (%s) from RootDSE at %s.",o.defaultNamingContext,r.opts.url),n("CN=Deleted Objects,"+o.defaultNamingContext,i))})))},x.prototype.findGroup=function(t,e,r){var n=this;"function"==typeof e&&(r=e,e=t,t=void 0),"string"==typeof t&&(e=t,t=void 0),E.trace("findGroup(%j,%s)",t,e);var i=p.defaults(p.omit(t||{},"attributes"),{filter:I.call(n,e),scope:"sub",attributes:B((t||{}).attributes||D.group,Z(t))});z.call(n,i,(function(o,s){if(o)r&&r(o);else{if(!s||0===s.length)return E.warn('Group "%s" not found for query "%s"',e,G(i.filter)),void(r&&r());var u=new m(J(s[0],(t||{}).attributes||D.group));E.info('%d group(s) found for query "%s". Returning first group: %j',s.length,G(i.filter),u),tt(t,"group")?K.call(n,t,u.dn,(function(t,e){t?r&&r(t):(u.groups=e,n.emit("group",u),r&&r(t,u))})):(n.emit("group",u),r&&r(o,u))}}))},x.prototype.findGroups=function(t,e){var r=this,n="(objectClass=group)(!(objectClass=computer))(!(objectClass=user))(!(objectClass=person))";"function"==typeof t&&(e=t,t=""),"string"==typeof t&&t&&(t={filter:"(&"+n+T(t)+")"}),E.trace("findGroups(%j)",t);var i=p.defaults(p.omit(t||{},"attributes"),{filter:"(&"+n+")",scope:"sub",attributes:B((t||{}).attributes||D.group||[],Z(t),["groupType"])});z.call(r,i,(function(n,o){if(n)e&&e(n);else{if(!o||0===o.length)return E.warn('No groups found matching query "%s"',G(i.filter)),void(e&&e());var s=[];c.forEach(o,(function(e,n){if(L(e)){var i=new m(J(e,(t||{}).attributes||D.user));s.push(i),tt(t,"group")?K.call(r,t,i.dn,(function(t,e){if(t)return n(t);i.groups=e,r.emit("group",i),n()})):(r.emit("group",i),n())}else n()}),(function(t){t?e&&e(t):(E.info('%d group(s) found for query "%s". Groups: %j',s.length,G(i.filter),s),r.emit("groups",s),e&&e(null,s))}))}}))},x.prototype.findUser=function(t,e,r,n){var i=this;"function"==typeof r&&(n=r,r=void 0),"function"==typeof e&&(n=e,e=t,t=void 0),"boolean"==typeof e&&(r=e,e=t),"string"==typeof t&&(e=t,t=void 0),E.trace("findUser(%j,%s,%s)",t,e,r);var o=p.defaults(p.omit(t||{},"attributes"),{filter:P.call(i,e),scope:"sub",attributes:B((t||{}).attributes||D.user||[],$(t))});z.call(i,o,(function(s,u){if(s)n&&n(s);else{if(!u||0===u.length)return E.warn('User "%s" not found for query "%s"',e,G(o.filter)),void(n&&n());var a=new h(J(u[0],(t||{}).attributes||D.user));E.info('%d user(s) found for query "%s". Returning first user: %j',u.length,G(o.filter),a),tt(t,"user")||r?K.call(i,t,a.dn,(function(t,e){t?n&&n(t):(a.groups=e,i.emit("user",a),n&&n(t,a))})):(i.emit("user",a),n&&n(s,a))}}))},x.prototype.findUsers=function(t,e,r){var n=this,i="(|(objectClass=user)(objectClass=person))(!(objectClass=computer))(!(objectClass=group))";"function"==typeof e&&(r=e,e=!1),"function"==typeof t&&(r=t,t=""),"string"==typeof t&&t&&(t={filter:"(&"+i+T(t)+")"}),E.trace("findUsers(%j,%s)",t,e);var o=p.defaults(p.omit(t||{},"attributes"),{filter:"(&"+i+")",scope:"sub",attributes:B((t||{}).attributes||D.user||[],$(t),["objectCategory"])});z.call(n,o,(function(i,s){if(i)r&&r(i);else{if(!s||0===s.length)return E.warn('No users found matching query "%s"',G(o.filter)),void(r&&r());var u=[];c.forEach(s,(function(r,i){if(M(r)){var o=new h(J(r,(t||{}).attributes||D.user));u.push(o),tt(t,"user")||e?K.call(n,t,o.dn,(function(t,e){if(t)return i(t);o.groups=e,n.emit("user",o),i()})):(n.emit("user",o),i())}else i()}),(function(e){e?r&&r(e):(E.info('%d user(s) found for query "%s". Users: %j',u.length,G(t.filter),u),n.emit("users",u),r&&r(null,u))}))}}))},x.prototype.authenticate=function(t,e,r){var n=this;if(E.trace("authenticate(%j,%s)",t,"********"),!t||!e){return r({code:49,errno:"LDAP_INVALID_CREDENTIALS",description:"The supplied credential is invalid"},!1)}var i=!1;function o(t){if(!i)return i=!0,O.call(n,"error")&&n.emit("error",t),r(t,!1)}var s=F.call(n);s.on("error",o),s.bind(t,e,(function(e){s.unbind();var i=f.format('Authentication %s for "%s" as "%s" (password: "%s")',e?"failed":"succeeded",n.opts.url,t,"********");return e?(E.warn("%s. Error: %s",i,e),o(e)):(E.info(i),r(e,!0))}))},x.prototype.getRootDSE=function(t,e,r){var n=this;if("function"==typeof e&&(r=e,e=void 0),"function"==typeof t&&(r=t,t=n.url||n.opts.url,e=void 0),!t)throw new Error('No url specified for the root DSE. Please specify an ldap url in the following format: "ldap://yourdomain.com:389".');function i(e){"ECONNRESET"!==(e||{}).errno&&(E.error('An unhandled error occured when searching for the root DSE at "%s". Error: %j',t,e),O.call(n,"error")&&n.emit("error",e))}E.trace("getRootDSE(%s,%j)",t,e||["*"]);var o=F.call(this,t);o.on("error",i),o.bind("","",(function(n){if(n)return E.error('Anonymous bind to "%s" failed. Error: %s',t,n),r(n,!1);o.search("",{scope:"base",attributes:e||["*"],filter:"(objectClass=*)"},(function(e,n){if(e)return E.error('Root DSE search failed for "%s". Error: %s',t,e),r(e);n.on("error",i),n.on("end",(function(t){o.unbind()})),n.on("searchEntry",(function(t){r(null,p.omit(t.object,"controls"))}))}))}))},t=x,module.exports=t;
//# sourceMappingURL=index.js.map
